name: Gemini AI Analysis

# AI-powered code analysis using Gemini CLI (direct invocation)
# Provides intelligent PR reviews, issue triage, and comprehensive analysis
# Requires vars.ENABLE_AI_ANALYSIS=true and secrets.GEMINI_API_KEY to activate

on:
  # Automatic triggers
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, labeled]

  # Manual trigger for comprehensive analysis
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to perform'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - 'pr-review'
          - 'issue-triage'
          - 'security-analysis'
          - 'performance-analysis'
          - 'comprehensive'
      focus_area:
        description: 'Focus area (optional - path or component)'
        required: false
        type: string
      prompt:
        description: 'Custom prompt for AI analysis (optional)'
        required: false
        type: string

# Required permissions for Gemini CLI operations
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  # Job 1: Automatic PR Review
  pr-review:
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install google-genai SDK
        run: pip install google-genai

      - name: Get PR diff
        id: diff
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20 | tr '\n' ' ')" >> $GITHUB_OUTPUT
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr_diff.txt
          echo "diff_size=$(wc -c < /tmp/pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Run Gemini PR Review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > /tmp/review_prompt.txt << 'PROMPT_EOF'
          You are an expert code reviewer for a CI/CD framework project.

          **Project Context**: This is a comprehensive CI/CD framework that provides:
          - Intelligent change detection and optimization
          - Multi-tier quality gates (essential/comprehensive/extended)
          - Performance monitoring and regression detection
          - Multi-layer security scanning
          - Cross-platform validation

          **Changed Files**: ${{ steps.diff.outputs.files }}

          **Your Task**: Review the PR changes and provide:
          1. **Summary** (2-3 sentences)
          2. **Code Quality** (rating 1-10, key observations)
          3. **Security** (any concerns?)
          4. **Suggestions** (top 3 improvements)

          Keep the review concise and actionable.
          PROMPT_EOF

          # Truncate diff if too large (keep first 10000 chars)
          head -c 10000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt

          python3 << 'EOF'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/review_prompt.txt', 'r') as f:
              prompt = f.read()

          with open('/tmp/pr_diff_truncated.txt', 'r') as f:
              diff = f.read()

          full_prompt = f"{prompt}\n\n**Diff:**\n```\n{diff}\n```"

          response = client.models.generate_content(
              model='gemini-2.0-flash-exp',
              contents=full_prompt
          )

          review = response.text

          # Save for next step
          with open('/tmp/ai_review.md', 'w') as f:
              f.write(review)

          print(review)
          EOF

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let aiReview = "AI review completed. Check job logs for details.";

            try {
              aiReview = fs.readFileSync('/tmp/ai_review.md', 'utf8');
            } catch (error) {
              console.log('Could not read review file:', error.message);
            }

            const comment = `## ðŸ¤– Gemini AI Code Review

            ${aiReview}

            ---
            *Generated by [CI Framework](https://github.com/Claire-s-Monster/ci-framework) Gemini AI*
            *PR: #${context.issue.number} | Event: ${context.eventName}*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 2: Automatic Issue Triage
  issue-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install google-genai SDK
        run: pip install google-genai

      - name: Run Issue Triage
        id: triage
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          python3 << 'EOF'
          import os
          import json
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          prompt = f"""You are an expert project maintainer for a CI/CD framework.

          **Issue Details**:
          - Title: {os.environ.get('ISSUE_TITLE', 'N/A')}
          - Body: {os.environ.get('ISSUE_BODY', 'N/A')[:2000]}
          - Author: {os.environ.get('ISSUE_AUTHOR', 'N/A')}

          Classify this issue and respond with ONLY a JSON object:
          {{
            "type": "bug|feature|enhancement|documentation|question",
            "priority": "critical|high|medium|low",
            "labels": ["label1", "label2"],
            "summary": "one sentence summary"
          }}

          Available labels: bug, enhancement, documentation, question, help wanted, good first issue
          """

          response = client.models.generate_content(
              model='gemini-2.0-flash-exp',
              contents=prompt
          )

          result = response.text
          print(result)

          with open('/tmp/triage_result.json', 'w') as f:
              f.write(result)
          EOF

      - name: Apply Labels and Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let labels = ['question'];
            let summary = 'Issue received and under review.';

            try {
              const raw = fs.readFileSync('/tmp/triage_result.json', 'utf8');
              // Extract JSON from markdown code blocks if present
              const jsonMatch = raw.match(/```json?\s*([\s\S]*?)\s*```/) || [null, raw];
              const result = JSON.parse(jsonMatch[1] || raw);
              labels = result.labels || [result.type || 'question'];
              summary = result.summary || summary;
            } catch (error) {
              console.log('Could not parse triage result:', error.message);
            }

            // Apply labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels.slice(0, 3)  // Max 3 labels
            });

            // Add triage comment
            const comment = [
              '## ðŸ¤– AI Triage Complete',
              '',
              `**Summary**: ${summary}`,
              `**Classification**: ${labels.join(', ')}`,
              '**Status**: Under review by maintainers',
              '',
              '---',
              '*Automated triage by [CI Framework](https://github.com/Claire-s-Monster/ci-framework) Gemini AI*'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 3: Manual Comprehensive Analysis
  comprehensive-analysis:
    if: github.event_name == 'workflow_dispatch' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install google-genai SDK
        run: pip install google-genai

      - name: Gather Project Metrics
        id: metrics
        run: |
          echo "python_files=$(find . -name '*.py' | wc -l)" >> $GITHUB_OUTPUT
          echo "yaml_files=$(find .github/workflows -name '*.yml' -o -name '*.yaml' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "recent_commits=$(git log --oneline --since='1 month ago' | wc -l)" >> $GITHUB_OUTPUT

      - name: Run Comprehensive Analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type }}
          FOCUS_AREA: ${{ github.event.inputs.focus_area }}
          CUSTOM_PROMPT: ${{ github.event.inputs.prompt }}
        run: |
          # Get file listing for context
          find . -name "*.py" -o -name "*.yml" | head -30 > /tmp/file_list.txt

          python3 << 'EOF'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/file_list.txt', 'r') as f:
              files = f.read()

          analysis_type = os.environ.get('ANALYSIS_TYPE', 'comprehensive')
          focus = os.environ.get('FOCUS_AREA', 'entire project')
          custom = os.environ.get('CUSTOM_PROMPT', '')

          prompt = f"""You are a senior software architect analyzing a CI/CD framework.

          **Analysis Type**: {analysis_type}
          **Focus Area**: {focus}
          **Custom Instructions**: {custom or 'None'}

          **Project Files** (sample):
          {files}

          Provide a concise analysis with:
          1. **Key Findings** (3-5 bullet points)
          2. **Recommendations** (prioritized list)
          3. **Risk Areas** (if any)

          Keep response under 500 words.
          """

          response = client.models.generate_content(
              model='gemini-2.0-flash-exp',
              contents=prompt
          )

          print(response.text)

          with open('/tmp/analysis.md', 'w') as f:
              f.write(response.text)
          EOF

      - name: Generate Analysis Report
        run: |
          echo "## ðŸ” Comprehensive Project Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Type**: ${{ github.event.inputs.analysis_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Focus Area**: ${{ github.event.inputs.focus_area || 'Entire Project' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Project Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Files**: ${{ steps.metrics.outputs.python_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML Workflows**: ${{ steps.metrics.outputs.yaml_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Recent Commits**: ${{ steps.metrics.outputs.recent_commits }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– AI Analysis" >> $GITHUB_STEP_SUMMARY
          cat /tmp/analysis.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Analysis powered by Gemini AI*" >> $GITHUB_STEP_SUMMARY

  # Job 4: CI Impact Analysis (runs on PR)
  ci-failure-analysis:
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install google-genai SDK
        run: pip install google-genai

      - name: Get Changed Files
        id: changes
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed_files.txt
          cat /tmp/changed_files.txt

      - name: Analyze PR for CI Impact
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/changed_files.txt', 'r') as f:
              files = f.read()

          prompt = f"""You are a CI/CD expert. Analyze these changed files for CI impact:

          **Changed Files**:
          {files}

          Provide a brief assessment:
          1. **CI Impact Level**: Low/Medium/High
          2. **Workflow Changes**: Any .yml workflow files modified?
          3. **Key Concerns**: (if any)
          4. **Recommendation**: (one sentence)

          Be concise - max 150 words.
          """

          response = client.models.generate_content(
              model='gemini-2.0-flash-exp',
              contents=prompt
          )

          print(response.text)

          with open('/tmp/ci_analysis.md', 'w') as f:
              f.write(response.text)
          EOF

      - name: Post Analysis Summary
        run: |
          echo "## ðŸ” CI Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/ci_analysis.md >> $GITHUB_STEP_SUMMARY
