name: Gemini AI Analysis

# AI-powered code analysis using Gemini SDK via pixi
# Provides intelligent PR reviews, issue triage, and comprehensive analysis
# Requires vars.ENABLE_AI_ANALYSIS=true and secrets.GEMINI_API_KEY to activate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to perform'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - 'pr-review'
          - 'issue-triage'
          - 'security-analysis'
          - 'performance-analysis'
          - 'comprehensive'
      focus_area:
        description: 'Focus area (optional - path or component)'
        required: false
        type: string
      prompt:
        description: 'Custom prompt for AI analysis (optional)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  pr-review:
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.41.4
          cache: false

      - name: Create genai environment
        run: |
          mkdir -p /tmp/genai-env
          cat > /tmp/genai-env/pixi.toml << 'TOML'
          [project]
          name = "genai-runner"
          channels = ["conda-forge"]
          platforms = ["linux-64"]

          [dependencies]
          python = ">=3.11"

          [pypi-dependencies]
          google-genai = "*"
          TOML
          cd /tmp/genai-env && pixi install

      - name: Get PR diff
        id: diff
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20 | tr '\n' ' ')" >> $GITHUB_OUTPUT
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr_diff.txt

      - name: Run Gemini PR Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CHANGED_FILES: ${{ steps.diff.outputs.files }}
        run: |
          head -c 10000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt

          cat > /tmp/genai-env/review.py << 'PYTHON'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/pr_diff_truncated.txt', 'r') as f:
              diff = f.read()

          prompt = f"""You are an expert code reviewer for a CI/CD framework.

          **Changed Files**: {os.environ.get('CHANGED_FILES', 'N/A')}

          Review the PR and provide:
          1. **Summary** (2-3 sentences)
          2. **Code Quality** (1-10, key observations)
          3. **Security** (any concerns?)
          4. **Suggestions** (top 3)

          Be concise.

          **Diff:**
          ```
          {diff}
          ```"""

          response = client.models.generate_content(
              model='gemini-2.0-flash',
              contents=prompt
          )

          with open('/tmp/ai_review.md', 'w') as f:
              f.write(response.text)
          print(response.text)
          PYTHON

          cd /tmp/genai-env && pixi run python review.py

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let aiReview = "AI review completed. Check job logs for details.";
            try {
              aiReview = fs.readFileSync('/tmp/ai_review.md', 'utf8');
            } catch (e) {
              console.log('Could not read review:', e.message);
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Gemini AI Code Review\n\n${aiReview}\n\n---\n*Generated by CI Framework Gemini AI*`
            });

  issue-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.41.4
          cache: false

      - name: Create genai environment
        run: |
          mkdir -p /tmp/genai-env
          cat > /tmp/genai-env/pixi.toml << 'TOML'
          [project]
          name = "genai-runner"
          channels = ["conda-forge"]
          platforms = ["linux-64"]

          [dependencies]
          python = ">=3.11"

          [pypi-dependencies]
          google-genai = "*"
          TOML
          cd /tmp/genai-env && pixi install

      - name: Run Issue Triage
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat > /tmp/genai-env/triage.py << 'PYTHON'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          title = os.environ.get('ISSUE_TITLE', 'N/A')
          body = os.environ.get('ISSUE_BODY', 'N/A')[:2000]

          prompt = f"""Classify this GitHub issue:
          Title: {title}
          Body: {body}

          Respond with ONLY JSON:
          {{"type": "bug|feature|question", "labels": ["label1"], "summary": "one sentence"}}

          Labels: bug, enhancement, documentation, question, help wanted, good first issue"""

          response = client.models.generate_content(
              model='gemini-2.0-flash',
              contents=prompt
          )

          with open('/tmp/triage.json', 'w') as f:
              f.write(response.text)
          print(response.text)
          PYTHON

          cd /tmp/genai-env && pixi run python triage.py

      - name: Apply Labels and Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let labels = ['question'];
            let summary = 'Issue under review.';

            try {
              const raw = fs.readFileSync('/tmp/triage.json', 'utf8');
              const match = raw.match(/```json?\s*([\s\S]*?)\s*```/) || [null, raw];
              const result = JSON.parse(match[1] || raw);
              labels = result.labels || [result.type || 'question'];
              summary = result.summary || summary;
            } catch (e) {
              console.log('Parse error:', e.message);
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels.slice(0, 3)
            });

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– AI Triage\n\n**Summary**: ${summary}\n**Labels**: ${labels.join(', ')}\n\n---\n*Automated by CI Framework*`
            });

  comprehensive-analysis:
    if: github.event_name == 'workflow_dispatch' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.41.4
          cache: false

      - name: Create genai environment
        run: |
          mkdir -p /tmp/genai-env
          cat > /tmp/genai-env/pixi.toml << 'TOML'
          [project]
          name = "genai-runner"
          channels = ["conda-forge"]
          platforms = ["linux-64"]

          [dependencies]
          python = ">=3.11"

          [pypi-dependencies]
          google-genai = "*"
          TOML
          cd /tmp/genai-env && pixi install

      - name: Run Analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type }}
          FOCUS_AREA: ${{ github.event.inputs.focus_area }}
        run: |
          find . -name "*.py" -o -name "*.yml" | head -30 > /tmp/files.txt

          cat > /tmp/genai-env/analyze.py << 'PYTHON'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/files.txt', 'r') as f:
              files = f.read()

          prompt = f"""Analyze this CI/CD framework project.
          Type: {os.environ.get('ANALYSIS_TYPE', 'comprehensive')}
          Focus: {os.environ.get('FOCUS_AREA', 'all')}
          Files: {files}

          Provide: Key Findings (3-5 points), Recommendations, Risk Areas. Max 400 words."""

          response = client.models.generate_content(
              model='gemini-2.0-flash',
              contents=prompt
          )

          with open('/tmp/analysis.md', 'w') as f:
              f.write(response.text)
          print(response.text)
          PYTHON

          cd /tmp/genai-env && pixi run python analyze.py

      - name: Post Summary
        run: |
          echo "## ðŸ” AI Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ github.event.inputs.analysis_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/analysis.md >> $GITHUB_STEP_SUMMARY

  ci-failure-analysis:
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_ANALYSIS == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.41.4
          cache: false

      - name: Create genai environment
        run: |
          mkdir -p /tmp/genai-env
          cat > /tmp/genai-env/pixi.toml << 'TOML'
          [project]
          name = "genai-runner"
          channels = ["conda-forge"]
          platforms = ["linux-64"]

          [dependencies]
          python = ">=3.11"

          [pypi-dependencies]
          google-genai = "*"
          TOML
          cd /tmp/genai-env && pixi install

      - name: Analyze CI Impact
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed.txt

          cat > /tmp/genai-env/ci_check.py << 'PYTHON'
          import os
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          with open('/tmp/changed.txt', 'r') as f:
              files = f.read()

          prompt = f"""CI/CD expert: analyze these changed files for CI impact.
          Files: {files}

          Respond with:
          - Impact Level: Low/Medium/High
          - Workflow Changes: yes/no
          - Concerns: (if any)
          - Recommendation: (one line)

          Max 100 words."""

          response = client.models.generate_content(
              model='gemini-2.0-flash',
              contents=prompt
          )

          with open('/tmp/ci_impact.md', 'w') as f:
              f.write(response.text)
          print(response.text)
          PYTHON

          cd /tmp/genai-env && pixi run python ci_check.py

      - name: Post Summary
        run: |
          echo "## ðŸ” CI Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/ci_impact.md >> $GITHUB_STEP_SUMMARY
