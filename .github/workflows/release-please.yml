name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Release Please
        id: release
        uses: google-github-actions/release-please-action@v4
        with:
          # Type of package
          release-type: python
          # Package name (matches pyproject.toml)
          package-name: ci-framework-tools
          # Version file to update
          version-file: pyproject.toml
          # Changelog sections configuration
          changelog-sections: |
            [
              {"type":"feat","section":"🚀 Features","hidden":false},
              {"type":"fix","section":"🐛 Bug Fixes","hidden":false},
              {"type":"docs","section":"📚 Documentation","hidden":false},
              {"type":"chore","section":"🔧 Maintenance","hidden":false},
              {"type":"refactor","section":"♻️ Code Refactoring","hidden":false},
              {"type":"perf","section":"⚡ Performance Improvements","hidden":false},
              {"type":"test","section":"🧪 Tests","hidden":false},
              {"type":"ci","section":"👷 CI/CD","hidden":false},
              {"type":"build","section":"📦 Build System","hidden":false},
              {"type":"style","section":"💄 Styling","hidden":true},
              {"type":"revert","section":"⏪ Reverts","hidden":false}
            ]
          # Include component in tag
          include-component-in-tag: false
          # Bump minor for feat, patch for fix
          bump-minor-pre-major: true
          bump-patch-for-minor-pre-major: true
          # Custom changelog header
          changelog-header: |
            # Changelog
            
            All notable changes to the CI Framework will be documented in this file.
            
            The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
            and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          # Draft releases for review
          draft: false
          # Prerelease pattern
          prerelease: false

  # Optional: Publish to GitHub Packages or PyPI after release
  publish:
    needs: release-please
    runs-on: ubuntu-latest
    if: needs.release-please.outputs.release_created
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Install PIXI
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
          
      - name: Build Package
        run: |
          echo "📦 Building CI Framework v${{ needs.release-please.outputs.tag_name }}"
          pixi run build || echo "⚠️ Build step not configured yet"
          
      - name: Release Summary
        run: |
          echo "## 🎉 CI Framework Release ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Release successfully created and published!" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY