---
# ============================================================================
# REUSABLE CI/CD PIPELINE - Primary Entry Point
# ============================================================================
# This is the main reusable workflow for ci-framework. It can be called:
#
# 1. REMOTELY from any repository (recommended):
#    ```yaml
#    jobs:
#      ci:
#        uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@main
#        with:
#          pixi-environment: 'ci'
#          python-versions: '["3.10", "3.11", "3.12"]'
#        secrets: inherit
#    ```
#
# 2. LOCALLY after copying to your repository:
#    ```yaml
#    jobs:
#      ci:
#        uses: ./.github/workflows/reusable-ci.yml
#        secrets: inherit
#    ```
#
# See standalone-ci.yml for a simplified wrapper template (local use only).
# ============================================================================
name: Reusable CI/CD Pipeline

on:
  workflow_call:
    inputs:
      pixi-environment:
        description: "The PIXI environment to use (default, quality, dev, ci)"
        required: false
        type: string
        default: 'ci'
      python-versions:
        description: "JSON array of Python versions for the test matrix"
        required: false
        type: string
        default: '["3.10", "3.11", "3.12"]'
      os-matrix:
        description: "JSON array of OS for the test matrix"
        required: false
        type: string
        default: '["ubuntu-latest", "macos-latest"]'
      enable-performance:
        description: >-
          Enable performance benchmarks and regression analysis
        required: false
        type: boolean
        default: true
      enable-release:
        description: >-
          Enable automated releases to PyPI on main branch pushes
        required: false
        type: boolean
        default: true
      allowed-licenses:
        description: >-
          Comma-separated list of allowed licenses for dependency review
        required: false
        type: string
        default: 'MIT, Apache-2.0, BSD-3-Clause'
      package-path:
        description: >-
          Relative path to the package directory within the monorepo
        required: false
        type: string
        default: '.'
      editable-install:
        description: >-
          Install package in editable mode before testing (pixi-only)
        required: false
        type: boolean
        default: true
      enable-hygiene-check:
        description: >-
          Enable repository hygiene checks for dev artifacts
        required: false
        type: boolean
        default: true
    secrets:
      CODECOV_TOKEN:
        description: "Token for uploading coverage reports to Codecov"
        required: false
      PYPI_API_TOKEN:
        description: "Token for publishing packages to PyPI"
        required: false
      GH_PAT:
        description: >-
          Personal Access Token for actions requiring it (like PR comments)
        required: false
      SOURCERY_TOKEN:
        description: "Token for Sourcery AI code reviewer"
        required: false

jobs:
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      docs: ${{ steps.changes.outputs.docs }}
      tests: ${{ steps.changes.outputs.tests }}
      ci: ${{ steps.changes.outputs.ci }}
      performance: ${{ steps.changes.outputs.performance }}
      security: ${{ steps.changes.outputs.security }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - '${{ inputs.package-path }}/src/**'
              - '${{ inputs.package-path }}/framework/**'
              - '${{ inputs.package-path }}/pyproject.toml'
              - '${{ inputs.package-path }}/pixi.lock'
              - '!${{ inputs.package-path }}/framework/tests/**'
            docs:
              - '${{ inputs.package-path }}/docs/**'
              - '${{ inputs.package-path }}/*.md'
            tests:
              - '${{ inputs.package-path }}/tests/**'
              - '${{ inputs.package-path }}/framework/tests/**'
            ci:
              - '.github/workflows/**'
            performance:
              - '${{ inputs.package-path }}/tests/performance/**'
              - '${{ inputs.package-path }}/framework/tests/performance/**'
            security:
              - '.github/workflows/security.yml'
              - '${{ inputs.package-path }}/pyproject.toml'
              - '${{ inputs.package-path }}/pixi.toml'
              - '${{ inputs.package-path }}/pixi.lock'
              - '${{ inputs.package-path }}/requirements*.txt'

  hygiene:
    name: "ðŸ§¹ Repository Hygiene"
    runs-on: ubuntu-latest
    if: inputs.enable-hygiene-check
    steps:
      - uses: actions/checkout@v4
      - name: "Check for pixi project"
        working-directory: ${{ inputs.package-path }}
        run: |
          if [ ! -f pixi.toml ] && [ ! -f pixi.lock ]; then
            echo "::error::No pixi.toml or pixi.lock found. ci-framework requires pixi-based projects."
            exit 1
          fi
          echo "âœ… Pixi project detected"
      - name: "Check for tracked dev artifacts"
        working-directory: ${{ inputs.package-path }}
        run: |
          ERRORS=0
          # Check for __pycache__ directories
          if git ls-files --error-unmatch '*/__pycache__/*' 2>/dev/null; then
            echo "::error::__pycache__ directories are tracked in git"
            ERRORS=$((ERRORS + 1))
          fi
          # Check for .pyc files
          if git ls-files --error-unmatch '*.pyc' 2>/dev/null; then
            echo "::error::.pyc files are tracked in git"
            ERRORS=$((ERRORS + 1))
          fi
          # Check for .pytest_cache
          if git ls-files --error-unmatch '.pytest_cache/*' 2>/dev/null; then
            echo "::error::.pytest_cache is tracked in git"
            ERRORS=$((ERRORS + 1))
          fi
          # Check for .mypy_cache
          if git ls-files --error-unmatch '.mypy_cache/*' 2>/dev/null; then
            echo "::error::.mypy_cache is tracked in git"
            ERRORS=$((ERRORS + 1))
          fi
          # Check for .gitignore
          if [ ! -f .gitignore ]; then
            echo "::error::.gitignore file is missing"
            ERRORS=$((ERRORS + 1))
          fi
          # Warnings (non-fatal)
          if git ls-files --error-unmatch '*.env' 2>/dev/null; then
            echo "::warning::.env files are tracked in git"
          fi
          if git ls-files --error-unmatch '.DS_Store' 'Thumbs.db' 2>/dev/null; then
            echo "::warning::OS-specific files are tracked in git"
          fi
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS hygiene issues"
            exit 1
          fi
          echo "âœ… Repository hygiene checks passed"

  quality:
    name: "ðŸ’Ž Code Quality"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.src == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: "Setup PIXI Environment"
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
      - name: "Install Dependencies"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi install -e ${{ inputs.pixi-environment }}
      - name: "Run Linters, Formatters, Type Checkers"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi run -e ${{ inputs.pixi-environment }} quality

  test:
    name: "ðŸ§ª Test Python ${{ matrix.python-version }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.src == 'true' ||
      needs.detect-changes.outputs.tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(inputs.os-matrix) }}
        python-version: ${{ fromJson(inputs.python-versions) }}
    steps:
      - uses: actions/checkout@v4
      - name: "Setup Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: "Setup PIXI Environment"
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
      - name: "Install Dependencies"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi install -e ${{ inputs.pixi-environment }}
      - name: "Editable Install (pixi-only)"
        if: inputs.editable-install
        working-directory: ${{ inputs.package-path }}
        run: |
          if [ ! -f pixi.toml ] && [ ! -f pixi.lock ]; then
            echo "::error::No pixi.toml or pixi.lock found. ci-framework requires pixi-based projects."
            exit 1
          fi
          pixi run -e ${{ inputs.pixi-environment }} pip install -e . --no-deps
      - name: "Run Test Suite"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi run -e ${{ inputs.pixi-environment }} test

  security:
    name: "ðŸ›¡ï¸ Security Scan"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.security == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout CI Framework"
        uses: actions/checkout@v4
        with:
          repository: Claire-s-Monster/ci-framework
          path: ci-framework
      - name: "Setup PIXI Environment"
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
      - name: "Install Security Environment"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi install -e quality-extended
      - name: "Run Security Scans"
        working-directory: ${{ inputs.package-path }}
        run: |
          python ../ci-framework/framework/security/cli.py scan --path .
      - name: "Automated License Compliance Scanning"
        uses: actions/dependency-review-action@v4
        with:
          allow-licenses: ${{ inputs.allowed-licenses }}
      - name: "Initialize CodeQL"
        uses: github/codeql-action/init@v3
        with:
          languages: 'python'
      - name: "Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v3

  performance:
    name: "ðŸ“Š Performance Analysis"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: >-
      inputs.enable-performance &&
      needs.detect-changes.outputs.performance == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout CI Framework"
        uses: actions/checkout@v4
        with:
          repository: Claire-s-Monster/ci-framework
          path: ci-framework
      - name: "Setup PIXI Environment"
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
      - name: "Install Performance Environment"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi install -e dev
      - name: "Run Benchmarks"
        working-directory: ${{ inputs.package-path }}
        run: |
          python ../ci-framework/framework/performance/cli.py run --path .
      - name: "Compare to Baseline & Comment on PR"
        working-directory: ${{ inputs.package-path }}
        run: |
          python ../ci-framework/framework/performance/cli.py compare --path .
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

  build:
    name: "ðŸ“¦ Build Package"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: "Setup PIXI Environment"
        uses: prefix-dev/setup-pixi@v0.8.13
        with:
          pixi-version: v0.49.0
          cache: false
      - name: "Install Dependencies"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi install -e quality-ci
      - name: "Build sdist and wheel"
        working-directory: ${{ inputs.package-path }}
        run: |
          pixi run -e quality-ci build
      - uses: actions/upload-artifact@v4
        with:
          name: 'dist'
          path: '${{ inputs.package-path }}/dist/'

  release:
    name: "ðŸš€ Release & Publish"
    runs-on: ubuntu-latest
    needs: [build, quality, security]
    if: >-
      ${{ inputs.enable-release && github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout CI Framework"
        uses: actions/checkout@v4
        with:
          repository: Claire-s-Monster/ci-framework
          path: ci-framework
      - name: "Generate Changelog"
        id: changelog
        working-directory: ${{ inputs.package-path }}
        run: |
          python ../ci-framework/framework/reporting/cli.py \
            generate-changelog --path .
      - uses: actions/download-artifact@v4
        with:
          name: 'dist'
          path: 'dist/'
      - name: "Publish to PyPI"
        uses: pypa/gh-action-pypi-publish@release/v1

  self-heal:
    name: "ðŸ©¹ Self-Healing (Manual Trigger)"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout CI Framework"
        uses: actions/checkout@v4
        with:
          repository: Claire-s-Monster/ci-framework
          path: ci-framework
      - name: "Run Self-Healing Script"
        working-directory: ${{ inputs.package-path }}
        run: |
          echo "This is a placeholder for the self-healing mechanism."
          echo "In the future, this job could automatically fix common"
          echo "test failures."
          # Example: python ../ci-framework/framework/self_healing/cli.py \
          #   fix --path .

  summary:
    name: "âœ… CI Summary"
    runs-on: ubuntu-latest
    needs: [hygiene, quality, test, security, performance, build, release, self-heal]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout CI Framework"
        uses: actions/checkout@v4
        with:
          repository: Claire-s-Monster/ci-framework
          path: ci-framework
      - name: "Generate Run Summary"
        run: |
          python ci-framework/framework/reporting/cli.py \
            generate-summary --path ${{ inputs.package-path }} \
            --output-file summary.md
      - name: "Add Summary to Job Summary"
        run: |
          cat summary.md >> "$GITHUB_STEP_SUMMARY"
