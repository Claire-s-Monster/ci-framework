# New Features in CI Framework v2.3.0

This document describes the new features added to the CI Framework to enhance pixi-based project support and repository quality.

## Overview

The CI Framework v2.3.0 introduces four new features based on real-world usage patterns:

1. **Editable Package Install** - Automatically install packages in editable mode for testing
2. **Repository Hygiene Checks** - Prevent accidental commits of development artifacts
3. **Improved Security Scan Triggers** - Detect dependency and source code changes for security scans
4. **Format Check Visibility** - Better visibility of format check failures

All features are **optional** and **backward compatible**.

---

## Feature 1: Editable Package Install

### Problem

For pixi-based projects, the local package is not automatically installed in the environment. Tests that import the package fail with `ModuleNotFoundError`.

### Solution

The CI framework now automatically installs your package in editable mode before running tests.

### Usage

By default, this feature is **enabled**. To disable it:

```yaml
jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      editable-install: false  # Disable editable install
```

### How It Works

Before running tests, the CI framework executes:

```bash
pixi run -e ${{ inputs.pixi-environment }} pip install -e . --no-deps
```

This installs your package in editable mode without installing dependencies (which are already installed by pixi).

### Example

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      pixi-environment: 'ci'
      editable-install: true  # Default: true
```

---

## Feature 2: Repository Hygiene Checks

### Problem

Common development artifacts can accidentally be committed to git:
- `__pycache__` directories
- `.pyc` files
- Missing `.gitignore`
- `.env` files with secrets
- `.log` files
- OS-specific files (`.DS_Store`, `Thumbs.db`)

### Solution

A new composite action checks for these issues and fails the build if critical violations are found.

### Usage

By default, this feature is **enabled**. To disable it:

```yaml
jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      enable-hygiene-check: false  # Disable hygiene checks
```

### Standalone Usage

You can also use the hygiene check action independently:

```yaml
jobs:
  hygiene:
    name: Repository Hygiene
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Repository Hygiene
        uses: Claire-s-Monster/ci-framework/actions/repo-hygiene@v2.3.0
        with:
          fail-on-pycache: true           # Default: true
          fail-on-pyc: true                # Default: true
          fail-on-missing-gitignore: true  # Default: true
          warn-on-env-files: true          # Default: true
          warn-on-log-files: true          # Default: true
          warn-on-os-files: true           # Default: true
          project-dir: '.'                 # Default: '.'
```

### What Gets Checked

#### Critical Violations (Build Fails)
- âŒ `__pycache__` directories tracked in git
- âŒ `.pyc` files tracked in git
- âŒ Missing `.gitignore` file

#### Warnings (Build Continues)
- âš ï¸ `.env` files tracked in git
- âš ï¸ `.log` files tracked in git
- âš ï¸ `.DS_Store` files (macOS)
- âš ï¸ `Thumbs.db` files (Windows)

### Fixing Violations

If hygiene checks fail:

```bash
# Remove __pycache__ directories from git
find . -type d -name "__pycache__" -exec git rm -rf {} +

# Remove .pyc files from git
find . -type f -name "*.pyc" -exec git rm -f {} +

# Create .gitignore if missing
cat > .gitignore << EOF
__pycache__/
*.pyc
*.pyo
.env
.env.*
*.log
.DS_Store
Thumbs.db
EOF

# Commit the changes
git add .gitignore
git commit -m "chore: remove development artifacts and add .gitignore"
git push
```

### Example Output

```
ðŸ§¹ Repository Hygiene Check
==========================

Checking for __pycache__ directories...
âœ… No __pycache__ directories in git
Checking for .pyc files...
âœ… No .pyc files in git
Checking for .gitignore...
âœ… .gitignore file exists
Checking for .env files...
âš ï¸  .env files tracked in git
Checking for .log files...
âœ… No .log files in git
Checking for OS-specific files...
âœ… No OS-specific files in git

==========================
Hygiene Check Summary:
  Violations: 0
  Warnings: 1
==========================
âœ… All hygiene checks passed!
```

---

## Feature 3: Improved Security Scan Triggers

### Problem

The security job previously only triggered when `.github/workflows/security.yml` was modified. Dependency updates and source code changes didn't trigger security scans.

### Solution

Security scans now trigger when any of these files change:

```yaml
security:
  - '.github/workflows/security.yml'
  - 'pyproject.toml'           # Python dependencies
  - 'requirements*.txt'        # pip requirements
  - 'setup.py'                 # setuptools
  - 'setup.cfg'                # setuptools config
  - 'poetry.lock'              # Poetry lock file
  - 'pixi.lock'                # Pixi lock file
  - 'src/**'                   # Source code changes
```

### Usage

This feature is automatically enabled and requires no configuration changes.

### Benefits

- ðŸ”’ Security scans run on dependency updates
- ðŸ” Source code changes trigger vulnerability analysis
- âš¡ Faster feedback on security issues
- ðŸ“Š Better security posture

### Example

When you update dependencies:

```bash
# Update dependencies
pixi add requests

# Commit changes
git add pixi.lock pyproject.toml
git commit -m "chore: add requests dependency"
git push  # Security scan will run automatically!
```

---

## Feature 4: Format Check Visibility

### Problem

Format check results were bundled in the quality job, making it harder to see what failed.

### Solution

The quality job now has separate, visible steps:

1. **Run Linters** - `pixi run lint`
2. **Check Code Formatting** - `pixi run format-check`
3. **Run Type Checker** - `pixi run typecheck`

### Usage

This feature is automatically enabled and requires no configuration changes.

### Benefits

- ðŸ‘€ Better visibility of which quality check failed
- ðŸŽ¯ Faster debugging of CI failures
- ðŸ“Š Clearer GitHub Actions UI

### Example Output

Before (single step):
```
âœ… Run Linters, Formatters, Type Checkers
```

After (separate steps):
```
âœ… Run Linters
âŒ Check Code Formatting  <- Clear which step failed!
â­ï¸  Run Type Checker (skipped)
```

### Fixing Format Failures

If format check fails:

```bash
# Auto-fix formatting issues
pixi run format

# Commit the changes
git add .
git commit -m "style: auto-format code"
git push
```

---

## Migration Guide

### Upgrading from v2.2.0 to v2.3.0

No breaking changes! Simply update your workflow version:

```yaml
# Before
jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.2.0

# After
jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
```

### Recommended Configuration

For optimal results with pixi-based projects:

```yaml
jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      # Pixi environment
      pixi-environment: 'ci'
      
      # Enable editable install (recommended for pixi projects)
      editable-install: true
      
      # Enable hygiene checks (recommended for all projects)
      enable-hygiene-check: true
      
      # Python versions to test
      python-versions: '["3.10", "3.11", "3.12"]'
      
      # Operating systems to test
      os-matrix: '["ubuntu-latest", "macos-latest"]'
```

---

## Troubleshooting

### Editable Install Fails

If editable install fails with errors:

1. Ensure your `pyproject.toml` has proper package configuration:
   ```toml
   [build-system]
   requires = ["hatchling"]
   build-backend = "hatchling.build"
   
   [project]
   name = "your-package"
   version = "0.1.0"
   ```

2. Check that your package structure is correct:
   ```
   your-project/
   â”œâ”€â”€ pyproject.toml
   â”œâ”€â”€ src/
   â”‚   â””â”€â”€ your_package/
   â”‚       â””â”€â”€ __init__.py
   â””â”€â”€ tests/
   ```

3. If you don't need editable install, disable it:
   ```yaml
   with:
     editable-install: false
   ```

### Hygiene Check False Positives

If hygiene checks fail incorrectly:

1. Review the warnings - they may indicate real issues
2. If files are intentionally tracked, add them to exceptions
3. Consider disabling specific checks:
   ```yaml
   - name: Check Repository Hygiene
     uses: Claire-s-Monster/ci-framework/actions/repo-hygiene@v2.3.0
     with:
       fail-on-pycache: false  # Allow __pycache__ (not recommended)
   ```

### Security Scans Not Triggering

If security scans don't run when expected:

1. Check that your changes match the trigger patterns
2. Verify the security job is enabled in your workflow
3. Check GitHub Actions logs for details

---

## Best Practices

### 1. Use Editable Install for Pixi Projects

For pixi-based projects with local packages:

```yaml
with:
  editable-install: true  # Required for local package imports
```

### 2. Always Enable Hygiene Checks

Prevent accidental commits:

```yaml
with:
  enable-hygiene-check: true  # Catch issues early
```

### 3. Keep .gitignore Updated

Ensure your `.gitignore` includes:

```gitignore
__pycache__/
*.pyc
*.pyo
.env
.env.*
*.log
.DS_Store
Thumbs.db
dist/
build/
*.egg-info/
```

### 4. Run Quality Checks Locally

Before pushing:

```bash
pixi run quality  # lint + format-check + typecheck
```

### 5. Monitor Security Scan Results

Review security findings regularly and keep dependencies updated.

---

## Examples

### Complete pixi-based Project

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  ci:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      pixi-environment: 'ci'
      editable-install: true
      enable-hygiene-check: true
      python-versions: '["3.10", "3.11", "3.12"]'
      os-matrix: '["ubuntu-latest", "macos-latest"]'
    secrets: inherit
```

### Monorepo Configuration

```yaml
jobs:
  package-a:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      package-path: 'packages/package-a'
      editable-install: true
      enable-hygiene-check: true
  
  package-b:
    uses: Claire-s-Monster/ci-framework/.github/workflows/reusable-ci.yml@v2.3.0
    with:
      package-path: 'packages/package-b'
      editable-install: true
      enable-hygiene-check: true
```

---

## Feedback and Contributing

These features were developed based on real-world usage in [llm-cli-runner](https://github.com/MementoRC/llm-cli-runner).

Have suggestions or found issues? Please:
- Open an issue: https://github.com/Claire-s-Monster/ci-framework/issues
- Submit a PR: https://github.com/Claire-s-Monster/ci-framework/pulls

---

## License

MIT License - See the main CI Framework repository for details.
